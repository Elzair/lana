#!/bin/sh

USAGE="Usage: $0 [-h] <nodejs|go|ruby|clojure|rust> <bitbucket|github> repository [branches...]"

if [ "$1" = "-h" ]
then
    echo "$USAGE"
    exit 0
fi

if [ $# -lt 3 ]
then
    echo "$USAGE" >&2
    exit 2
fi

LANGUAGE="$1"
PROVIDER="$2"
REPO="$3"
URL=""

case "${PROVIDER}" in
    bitbucket)
        URL="git@bitbucket.org:${REPO}.git"
        ;;
    github)
        URL="git@github.com:${REPO}.git"
        ;;
    *)
        echo "Unknown provider: ${PROVIDER}" >&2
        exit 1
        ;;
esac

REPODIR="/home/lana/repos/${REPO}"
LOGDIR="/home/lana/logs/${REPO}"

CMD="git clone ${URL} ${REPODIR}"
sudo -u lana $CMD

cd $REPODIR

x=0
for i in $*
do
    if [ $x -gt 2 ]
    then
        CMD="git checkout --track origin/${i}"
        sudo -u lana $CMD
    fi
    x=$(($x+1))
done

CMD="mkdir -p ${LOGDIR}"
sudo -u lana $CMD
